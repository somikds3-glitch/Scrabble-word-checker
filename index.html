// ==UserScript==
// @name         Somik’s Scrabble Panel (No-Key)
// @namespace    somik.scrabble.panel
// @version      1.0
// @description  Check Scrabble legality via Collins + show short meanings (Collins & Merriam). No API keys. One word at a time.
// @match        *://*/*
// @grant        none
// ==/UserScript==

(function(){
  const HOTKEY = {altKey:true, key:'s'}; // Alt+S to open prompt

  // -------- UI --------
  function panel(){
    let el = document.getElementById('somik-scrabble-panel');
    if (el) { el.remove(); }
    el = document.createElement('div');
    el.id = 'somik-scrabble-panel';
    el.innerHTML = `
      <style>
        #somik-scrabble-panel{position:fixed;right:16px;bottom:16px;z-index:999999;
          background:#16182d;color:#eef0ff;border:1px solid #2a2f63;border-radius:12px;
          width:min(420px,90vw);box-shadow:0 8px 22px rgba(0,0,0,.45);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial}
        #somik-scrabble-panel .hd{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #2a2f63}
        #somik-scrabble-panel .hd b{font-size:14px}
        #somik-scrabble-panel button{background:#2a2f63;border:1px solid #2a2f63;color:#eef0ff;border-radius:8px;padding:6px 10px;cursor:pointer}
        #somik-scrabble-panel .bd{padding:10px 12px;font-size:14px}
        #somik-scrabble-panel .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
        #somik-scrabble-panel .box{border:1px dashed #2a2f63;border-radius:8px;padding:8px;min-height:88px;position:relative}
        #somik-scrabble-panel .tag{position:absolute;right:8px;top:6px;font-size:11px;color:#9aa0ff}
        #somik-scrabble-panel .status{margin-top:2px;font-weight:600}
        #somik-scrabble-panel .ok{color:#34c38f} .no{color:#ff6b6b}
        #somik-scrabble-panel .def{margin-top:6px;color:#d7dbff;line-height:1.35}
        #somik-scrabble-panel .mini{margin-top:6px;color:#9aa0ff;font-size:12px}
        #somik-scrabble-panel a{color:#cfd3ff}
        #somik-scrabble-panel input{width:100%;margin-top:8px;padding:8px;border-radius:8px;border:1px solid #2a2f63;background:#0e1130;color:#eef0ff}
      </style>
      <div class="hd">
        <b>Somik’s Scrabble Word Panel (No-Key)</b>
        <div>
          <button id="ssp-close" title="Close">✕</button>
        </div>
      </div>
      <div class="bd">
        <div>Enter word (A–Z, 2–15):</div>
        <input id="ssp-input" placeholder="e.g., quiz, za, gapy, tod"/>
        <div class="row" style="margin-top:8px">
          <div class="box">
            <div class="tag">CSW Legality (Collins)</div>
            <div id="ssp-csw" class="status">—</div>
            <div id="ssp-csw-note" class="mini"></div>
          </div>
          <div class="box">
            <div class="tag">NWL Info (Merriam)</div>
            <div id="ssp-nwl" class="status">—</div>
            <div id="ssp-nwl-note" class="mini"></div>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div class="box">
            <div class="tag">Meaning (Collins)</div>
            <div id="ssp-collins-def" class="def">—</div>
            <div class="mini"><a id="ssp-collins-link" target="_blank" rel="noopener"></a></div>
          </div>
          <div class="box">
            <div class="tag">Meaning (Merriam-Webster)</div>
            <div id="ssp-mw-def" class="def">—</div>
            <div class="mini"><a id="ssp-mw-link" target="_blank" rel="noopener"></a></div>
          </div>
        </div>
        <div class="mini" id="ssp-links" style="margin-top:6px"></div>
      </div>
    `;
    document.body.appendChild(el);
    el.querySelector('#ssp-close').onclick = ()=> el.remove();
    const input = el.querySelector('#ssp-input');
    input.addEventListener('keydown', (e)=>{ if(e.key==='Enter') run(input.value.trim()); });
    setTimeout(()=> input.focus(), 60);
  }

  // -------- Net helpers --------
  const jina = (url)=> `https://r.jina.ai/http/${url.replace(/^https?:\/\//,'')}`;
  async function fetchText(url, timeout=9000){
    const ctl = new AbortController();
    const t = setTimeout(()=>ctl.abort(), timeout);
    try{
      const r = await fetch(jina(url), { signal: ctl.signal, cache:'no-store' });
      if(!r.ok) throw new Error('HTTP '+r.status);
      return await r.text();
    } finally { clearTimeout(t); }
  }

  // -------- Parsing --------
  const sanitize = (s)=> /^[A-Za-z]{2,15}$/.test(s||'') ? s.toLowerCase() : null;
  const norm = (t)=> (t||'').replace(/\s+/g,' ').toLowerCase();
  const escRe = (s)=> s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');

  function parseCollinsCSW(text, w){
    const T = norm(text), W = escRe(w);
    const ok = new RegExp(`\\b${W}\\b[^\\.!?]{0,80}(?:is|’s|is\\s+a)\\s+(?:a\\s+)?valid\\s+scrabble\\s+word`).test(T);
    const no = new RegExp(`\\b${W}\\b[^\\.!?]{0,80}(?:is\\s+not|isn['’]t|not)\\s+(?:a\\s+)?valid\\s+scrabble\\s+word`).test(T)
           || /\bno results\b|\bnot found\b|\bno definitions found\b/.test(T);
    return ok ? 'ok' : (no ? 'no' : 'unknown');
  }

  function firstCleanLine(lines, from=0, span=12){
    for(let i=from;i<Math.min(lines.length,from+span);i++){
      const L = lines[i].trim();
      if(!L) continue;
      if(/^(see also|word forms|examples?|scrabble|copyright)/i.test(L)) continue;
      if(/[a-z]/i.test(L) && L.split(' ').length>=2 && L.length<=180) return L;
    }
    return '';
  }
  function extractCollinsDef(t){
    const lines = t.split(/\n+/).map(s=>s.trim()).filter(Boolean);
    let i = lines.findIndex(l=>/meaning|definition|is a valid scrabble word/i.test(l));
    if(i>=0){ const s = firstCleanLine(lines,i+1,10); if(s) return s; }
    return firstCleanLine(lines,0,25) || '';
  }
  function extractMWDef(t){
    const lines = t.split(/\n+/).map(s=>s.trim()).filter(Boolean);
    let i = lines.findIndex(l=>/^definition of\b/i.test(l));
    if(i>=0){ const s = firstCleanLine(lines,i+1,12); if(s) return s; }
    i = lines.findIndex(l=>/^(noun|verb|adjective|adverb|interjection|preposition|pronoun)\b/i.test(l));
    if(i>=0){ const s = firstCleanLine(lines,i+1,10); if(s) return s; }
    return firstCleanLine(lines,0,25) || '';
  }

  // -------- Run check --------
  async function run(raw){
    const csw = document.getElementById('ssp-csw');
    const cswNote = document.getElementById('ssp-csw-note');
    const nwl = document.getElementById('ssp-nwl');
    const nwlNote = document.getElementById('ssp-nwl-note');
    const cDef = document.getElementById('ssp-collins-def');
    const cLink = document.getElementById('ssp-collins-link');
    const mDef = document.getElementById('ssp-mw-def');
    const mLink = document.getElementById('ssp-mw-link');
    const links = document.getElementById('ssp-links');

    csw.textContent = 'Checking Collins…'; csw.className='status';
    cswNote.textContent = '';
    nwl.textContent = 'Checking Merriam…'; nwl.className='status';
    nwlNote.textContent = '';
    cDef.textContent = mDef.textContent = '—';
    cLink.textContent = mLink.textContent = ''; cLink.removeAttribute('href'); mLink.removeAttribute('href');
    links.textContent = '';

    const w = sanitize(raw);
    if(!w){ csw.textContent='Letters A–Z only (2–15).'; nwl.textContent=''; return; }

    const uCSW = `https://www.collinsdictionary.com/scrabble/scrabble-word-checker/${w}`;
    const uCollins = `https://www.collinsdictionary.com/dictionary/english/${w}`;
    const uMW = `https://www.merriam-webster.com/dictionary/${w}`;
    const uNWL = `https://scrabble.merriam.com/finder/${w}`;

    // Legality (strict: Collins only)
    try{
      const t = await fetchText(uCSW, 9000);
      const v = parseCollinsCSW(t, w);
      csw.className = 'status ' + (v==='ok'?'ok':v==='no'?'no':'');
      csw.textContent = v==='ok'?'Playable ✓':v==='no'?'Not allowed ✕':'Unknown';
      cswNote.textContent = v==='ok' ? 'High confidence — Collins explicitly confirms.'
                         : v==='no' ? 'High confidence — Collins explicitly rejects.'
                         : 'Collins did not explicitly confirm.';
    }catch(err){
      csw.textContent = 'Collins check failed';
      cswNote.textContent = (err && err.name==='AbortError') ? 'Timed out.' : String(err).slice(0,140);
    }

    // Meanings
    try{
      const t2 = await fetchText(uCollins, 9000);
      const d = extractCollinsDef(t2);
      cDef.textContent = d || 'No short snippet found. Open source.';
      cLink.href = uCollins; cLink.textContent = `Open Collins dictionary for “${w}”`;
    }catch{
      cDef.textContent = 'Could not fetch Collins dictionary page.';
      cLink.href = uCollins; cLink.textContent = `Try Collins dictionary for “${w}”`;
    }

    try{
      const t3 = await fetchText(uMW, 9000);
      const d = extractMWDef(t3);
      mDef.textContent = d || 'No short snippet found. Open source.';
      mLink.href = uMW; mLink.textContent = `Open Merriam-Webster for “${w}”`;
    }catch{
      mDef.textContent = 'Could not fetch Merriam-Webster page.';
      mLink.href = uMW; mLink.textContent = `Try Merriam-Webster for “${w}”`;
    }

    // NWL info-only (can say "no" if explicit)
    try{
      const t4 = await fetchText(uNWL, 9000);
      const T4 = (t4||'').replace(/\s+/g,' ').toLowerCase();
      const no = /\bno results\b|\bnot a playable word\b/.test(T4);
      nwl.className = 'status ' + (no?'no':'');
      nwl.textContent = no ? 'Not allowed ✕' : 'Unknown';
      nwlNote.textContent = no ? 'Merriam shows no results / not playable.' : 'Merriam finder does not explicitly confirm.';
    }catch(err){
      nwl.textContent = 'Merriam check failed';
      nwlNote.textContent = (err && err.name==='AbortError') ? 'Timed out.' : String(err).slice(0,140);
    }

    // quick source links in footer
    links.innerHTML = `<a href="${uCSW}" target="_blank" rel="noopener">Collins Scrabble</a> · <a href="${uCollins}" target="_blank" rel="noopener">Collins Dict</a> · <a href="${uMW}" target="_blank" rel="noopener">Merriam Dict</a>`;
  }

  // Hotkey to open panel
  window.addEventListener('keydown', (e)=>{
    if (e.altKey===HOTKEY.altKey && e.key.toLowerCase()===HOTKEY.key) {
      e.preventDefault();
      panel();
    }
  });
})();